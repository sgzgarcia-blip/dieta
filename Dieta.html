<!DOCTYPE html>
<html lang="es">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8">
  <title>Dieta y Macros Din√°micos</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial;
      background: #f4f6f9;
      margin: 0;
      padding: 15px
    }

    .container {
      max-width: 900px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 10px
    }

    form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px
    }

    input,
    select,
    button {
      padding: 10px;
      font-size: 16px
    }

    button {
      background: #2c7be5;
      color: #fff;
      border: none;
      border-radius: 6px
    }

    .card {
      background: #f9fafb;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px
    }

    canvas {
      margin-top: 30px
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üçΩ Dieta personalizada de #name# + üìä Progreso</h1>

    <form id="form">
      <select id="sexo">
        <option value="hombre">Hombre</option>
        <option value="mujer">Mujer</option>
      </select>
      <input type="number" id="edad" placeholder="Edad" required>
      <input type="number" id="peso" placeholder="Peso (kg)" required>
      <input type="number" id="altura" placeholder="Altura (cm)" required>

      <select id="actividad">
        <option value="1.2">Sedentario</option>
        <option value="1.375">Ligero</option>
        <option value="1.55">Moderado</option>
        <option value="1.725">Alto</option>
      </select>

      <select id="objetivo">
        <option value="definicion">Definici√≥n</option>
        <option value="mantenimiento">Mantenimiento</option>
        <option value="volumen">Volumen</option>
      </select>
      <select id="tipoD">
      </select>
      <button onclick="calcular()">Calcular dieta</button>
    </form>
    <div id="resultado"></div>
    <canvas id="chart"></canvas>
  </div>
  <script>

    const datos = localStorage.getItem("dietaDatos");
    let name = "Default";
    if (datos) {
      name = JSON.parse(datos).name;
    }
    const params = new URLSearchParams(location.search);
    name = params.get("name")?.trim() || name;

    const script = document.createElement('script');
    script.src = `./data/${name}.js`;
    script.async = false;
    document.head.appendChild(script);

    const icons = {
      "Desayuno": `üåÖ`,
      "Media ma√±ana": `üïô`,
      "Comida": `üçΩÔ∏è`,
      "Merienda": `üïî`,
      "Cena": `üåô`
    }

    const sexoEl = document.getElementById("sexo");
    const edadEl = document.getElementById("edad");
    const pesoEl = document.getElementById("peso");
    const alturaEl = document.getElementById("altura");
    const actividadEl = document.getElementById("actividad");
    const objetivoEl = document.getElementById("objetivo");
    const tipoDEl = document.getElementById("tipoD");
    const resultado = document.getElementById("resultado");
    const ctx = document.getElementById("chart");
    let chart;

    document.querySelector('h1').textContent = document.querySelector('h1').textContent.replace("#name#", name);

    window.onload = function () {
      const datos = localStorage.getItem("dietaDatos");
      if (!datos) return;

      const d = JSON.parse(datos);
      //A√±adir un nuevo par√°metro (ej. "name=")
      updateURL(d.name);
      sexoEl.value = d.sexo;
      edadEl.value = d.edad;
      pesoEl.value = d.peso;
      alturaEl.value = d.altura;
      actividadEl.value = d.actividad;
      objetivoEl.value = d.objetivo;
      addOptionTipoD();
      tipoDEl.value = d.tipoD;
      resultado.innerHTML = d.result;
    };

    // üìö HISTORIAL
    const loadHistory = () => JSON.parse(localStorage.getItem("history")) || [];

    const saveHistory = (data) => {
      const history = loadHistory();
      history.push(data);
      localStorage.setItem("history", JSON.stringify(history.slice(-10)));
    };


    function calcular() {

      const sexo = sexoEl.value;
      const edad = +edadEl.value;
      const peso = +pesoEl.value;
      const altura = +alturaEl.value;
      const actividad = +actividadEl.value;
      const objetivo = objetivoEl.value;
      const tipoD = tipoDEl.value;

      let tmb = sexo === "hombre"
        ? 10 * peso + 6.25 * altura - 5 * edad + 5
        : 10 * peso + 6.25 * altura - 5 * edad - 161;

      let calorias = tmb * actividad;

      if (objetivo === "definicion") calorias -= 400;
      if (objetivo === "volumen") calorias += 350;

      calorias = Math.round(calorias);

      const proteinas = Math.round(peso * (objetivo === "definicion" ? 2.2 : 1.8));
      const grasas = Math.round(peso * 0.9);
      const caloriasRestantes =
        calorias - (proteinas * 4 + grasas * 9);
      const carbos = Math.round(caloriasRestantes / 4);

      const objetivos = {};
      !alimentos.hasOwnProperty(tipoD) || Object.entries(alimentos[tipoD]).forEach(([key, value]) => {
        let lon = (1/Object.entries(alimentos[tipoD]).length).toFixed(2);
        objetivos[key] = {
          kcal: Math.round(calorias * lon),
          prote: Math.round(proteinas * lon),
          carbs: Math.round(carbos * lon),
          grasa: Math.round(grasas * lon)
        };
      });


      let resultD = {};
      let diet = "";
      !alimentos.hasOwnProperty(tipoD) || Object.entries(alimentos[tipoD]).forEach(([key, value]) => {
        // üçΩ alimentos (aprox)
        diet = diet + `\n    ${icons[key]} ${key}: \n${pintar(alimentos[tipoD][key], optimizadorFlexible(value, objetivos[key], obtenerPrioridades(objetivo)))}`;
      });

      const result = `
    <h3>MacroNutrientes</h3><pre>
    üî• Calor√≠as: ${calorias} kcal
    ü•© Prote√≠nas: ${proteinas} g
    ü•ë Grasas: ${grasas} g
    üçö Carbohidratos: ${carbos} g
    <hr>
    \t${diet}
    <hr>
    üèãÔ∏è Entrenamiento</pre>
    `;

      resultado.innerHTML = result;
      // üîê Guardar datos
      localStorage.setItem("dietaDatos", JSON.stringify({
        name, sexo, edad, peso, altura, actividad, objetivo, tipoD, result
      }));

      saveHistory({ date: new Date().toLocaleDateString(), calorias, proteinas, carbos, grasas });
      drawChart();


    }

    function optimizadorFlexible(alimentos, objetivos, prioridad) {

      const iteraciones = 3000;
      const learningRate = 0.01;

      let gramos = new Array(alimentos.length).fill(100);

      function calcularTotales(gs) {
        let kcal = 0, prote = 0, carbs = 0, grasa = 0;

        gs.forEach((g, i) => {
          kcal += g * alimentos[i].kcal / 100;
          prote += g * alimentos[i].proteina / 100;
          carbs += g * alimentos[i].carbs / 100;
          grasa += g * alimentos[i].grasa / 100;
        });

        return { kcal, prote, carbs, grasa };
      }

      function varianza(array) {
        const media = array.reduce((a, b) => a + b, 0) / array.length;
        return array.reduce((acc, val) =>
          acc + Math.pow(val - media, 2), 0) / array.length;
      }

      function coste(gs) {

        const t = calcularTotales(gs);

        return (
          Math.abs(t.kcal - objetivos.kcal) * prioridad.calorias +
          Math.abs(t.prote - objetivos.prote) * prioridad.proteina +
          Math.abs(t.carbs - objetivos.carbs) * prioridad.carbs +
          Math.abs(t.grasa - objetivos.grasa) * prioridad.grasa +
          varianza(gs) * prioridad.equilibrio
        );
      }

      for (let iter = 0; iter < iteraciones; iter++) {

        const baseCoste = coste(gramos);

        for (let i = 0; i < gramos.length; i++) {

          const copia = [...gramos];
          copia[i] += 1;

          const gradiente = coste(copia) - baseCoste;

          gramos[i] -= learningRate * gradiente;

          if (gramos[i] < 0) gramos[i] = 0;
        }
      }

      return {
        gramos: gramos.map(g => Math.round(g)),
        totales: calcularTotales(gramos)
      };
    }

    function obtenerPrioridades(modo) {

      switch (modo) {

        case "definicion":
          return {
            calorias: 3,
            proteina: 5,
            carbs: 1,
            grasa: 4,
            equilibrio: 0.002
          };

        case "volumen":
          return {
            calorias: 3,
            proteina: 3,
            carbs: 3,
            grasa: 1,
            equilibrio: 0.2
          };

        case "mantenimiento":
          return {
            calorias: 2,
            proteina: 2,
            carbs: 2,
            grasa: 2,
            equilibrio: 0.02
          };
      }
    }
    function pintar(alimentos, result) {
      var paint = "";
      result.gramos.forEach((g, i) => {
        paint += `\t-${alimentos[i].nombre}: ${g} g\n`;
      });
      paint += `\n\tTotales: \n\t kcal: ${Math.round(result.totales.kcal)} \n\t Prote: ${Math.round(result.totales.prote)} \n\t Carbs: ${Math.round(result.totales.carbs)} \n\t Grasa: ${Math.round(result.totales.grasa)}`;
      return paint;
    }

    function drawChart() {
      const history = loadHistory();
      const labels = history.map(h => h.date);
      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            { label: "Calor√≠as", data: history.map(h => h.calorias), borderWidth: 2 },
            { label: "Prote√≠na", data: history.map(h => h.proteinas), borderWidth: 2 },
            { label: "Carbos", data: history.map(h => h.carbos), borderWidth: 2 },
            { label: "Grasas", data: history.map(h => h.grasas), borderWidth: 2 }
          ]
        },
        options: { responsive: true }
      });
    }

    function getRandomInt(max) {
      return Math.floor(Math.random() * max);
    }

    function updateURL(name) {
      window.history.pushState({}, '', `${window.location.pathname}?name=${name || ''}`);
    }

    function addOptionTipoD() {
      var tSelect = document.getElementById("tipoD");
      Object.entries(alimentos).forEach(([key, value]) => {
        var option = document.createElement("option");
        option.text = key;
        tSelect.add(option);
      });
    }
    drawChart();
  </script>
</body>

</html>