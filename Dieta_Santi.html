<!DOCTYPE html>
<html lang="es">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta charset="UTF-8">
<title>Dieta y Macros DinÃ¡micos</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{font-family:Arial;background:#f4f6f9;margin:0;padding:15px}
.container{max-width:900px;margin:auto;background:#fff;padding:20px;border-radius:10px}
form{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px}
input,select,button{padding:10px;font-size:16px}
button{background:#2c7be5;color:#fff;border:none;border-radius:6px}
.card{background:#f9fafb;padding:15px;border-radius:8px;margin-top:15px}
canvas{margin-top:30px}
</style>
</head>

<body>
<div class="container">
<h1>ğŸ½ Dieta personalizada de #name# + ğŸ“Š Progreso</h1>

<form id="form">
<select id="sexo">
    <option value="hombre">Hombre</option>
    <option value="mujer">Mujer</option>
</select>
<input type="number" id="edad" placeholder="Edad" required>
<input type="number" id="peso" placeholder="Peso (kg)" required>
<input type="number" id="altura" placeholder="Altura (cm)" required>

<select id="actividad">
<option value="1.2">Sedentario</option>
<option value="1.375">Ligero</option>
<option value="1.55">Moderado</option>
<option value="1.725">Alto</option>
</select>

<select id="objetivo">
    <option value="definicion">DefiniciÃ³n</option>
    <option value="mantenimiento">Mantenimiento</option>
    <option value="volumen">Volumen</option>
</select>
<select id="tipoD">
    <option value="proteanimal">Proteina Animales</option>
    <option value="protevegetal">Proteina Vegetal</option>
</select>
<button onclick="calcular()">Calcular dieta</button>
</form>
<div id="resultado"></div>
<canvas id="chart"></canvas>
</div>
<script>

const alimentos = {
   proteanimal: {
      desayuno: [
        { nombre: "Tortilla", kcal: 42, proteina: 11, carbs: 0.5, grasa: 0.5 },
        { nombre: "Tortita", kcal: 293, proteina: 18, carbs: 37, grasa: 7 },
        { nombre: "Crema de cacahuetes", kcal: 683, proteina: 31.9, carbs: 10.1, grasa: 55.6 },
        { nombre: "CafÃ©", kcal: 2, proteina: 6, carbs: 4.6, grasa: 0.2 }
      ],
      comida: [
        { nombre: "Quinoa", kcal: 389, proteina: 14, carbs: 66.5, grasa: 6.1 },
        { nombre: "Arroz", kcal: 350, proteina: 7.6, carbs: 72, grasa: 2.8 },
        { nombre: "Pollo", kcal: 120, proteina: 24, carbs: 0, grasa: 2 }
      ],
      merienda: [
        { nombre: "ProteÃ­na de suero", kcal: 42, proteina: 78, carbs: 3.4, grasa: 8.5 },
        { nombre: "Pechuga de pollo", kcal: 89, proteina: 18.1, carbs: 1, grasa: 1.7 },
        { nombre: "Pechuga de pavo", kcal: 91, proteina: 19.5, carbs: 1, grasa: 1.3 }
      ],
      cena: [
        { nombre: "Queso cottage", kcal: 98, proteina: 11.5, carbs: 2.8, grasa: 4.5 },
        { nombre: "Nueces", kcal: 709, proteina: 18, carbs: 2.9, grasa: 68 },
        { nombre: "Miel", kcal: 332, proteina: 0, carbs: 83, grasa: 0 }
      ]
   },
  protevegetal: {
      desayuno: [
        { nombre: "Tortilla", kcal: 42, proteina: 11, carbs: 0.5, grasa: 0.5 },
        { nombre: "Arandanos", kcal: 324, proteina: 1, carbs: 79, grasa: 1.4 },
        { nombre: "Avena", kcal: 372, proteina: 14, carbs: 59, grasa: 7 },
        { nombre: "CafÃ©", kcal: 2, proteina: 6, carbs: 4.6, grasa: 0.2 }
      ],
      comida: [
        { nombre: "Quinoa", kcal: 389, proteina: 14, carbs: 66.5, grasa: 6.1 },
        { nombre: "Arroz", kcal: 350, proteina: 7.6, carbs: 72, grasa: 2.8 },
        { nombre: "Pollo", kcal: 120, proteina: 24, carbs: 0, grasa: 2 }
      ],
      merienda: [
        { nombre: "ProteÃ­na de suero", kcal: 42, proteina: 78, carbs: 3.4, grasa: 8.5 },
        { nombre: "Manzana", kcal: 52, proteina: 0.3, carbs: 22, grasa: 0 },
        { nombre: "Frutos secos", kcal: 709, proteina: 18, carbs: 2.9, grasa: 68 }
      ],
      cena: [
        { nombre: "Caldo", kcal: 4.2, proteina: 0.3, carbs: 0.2, grasa: 0.3 },
        { nombre: "Queso en polvo", kcal: 286, proteina: 23.7, carbs: 8.6, grasa: 17.4 },
        { nombre: "AtÃºn natural", kcal: 333, proteina: 18, carbs: 0.5, grasa: 0.6 },
        { nombre: "Soja texturizada", kcal: 361, proteina: 50, carbs: 13, grasa: 8.8 }
      ]
   }
}


const sexoEl = document.getElementById("sexo");
const edadEl = document.getElementById("edad");
const pesoEl = document.getElementById("peso");
const alturaEl = document.getElementById("altura");
const actividadEl = document.getElementById("actividad");
const objetivoEl = document.getElementById("objetivo");
const tipoDEl = document.getElementById("tipoD");
const resultado = document.getElementById("resultado");
const ctx = document.getElementById("chart");
let chart;

document.querySelector('h1').textContent = document.querySelector('h1').textContent.replace("#name#", window.location.pathname.split('/').pop().replace("Dieta_", "").replace(".html", ""));

window.onload = function() {
    const datos = localStorage.getItem("dietaDatos");
    if (!datos) return;

    const d = JSON.parse(datos);

    sexoEl.value = d.sexo;
    edadEl.value = d.edad;
    pesoEl.value = d.peso;
    alturaEl.value = d.altura;
    actividadEl.value = d.actividad;
    objetivoEl.value = d.objetivo;
    tipoDEl.value = d.tipoD;
    resultado.innerHTML = d.result;
};

// ğŸ“š HISTORIAL
const loadHistory = () => JSON.parse(localStorage.getItem("history")) || [];

const saveHistory = (data) => {
    const history = loadHistory();
    history.push(data);
    localStorage.setItem("history", JSON.stringify(history.slice(-10)));  
};


function calcular() {

    const sexo = sexoEl.value;
    const edad = +edadEl.value;
    const peso = +pesoEl.value;
    const altura = +alturaEl.value;
    const actividad = +actividadEl.value;
    const objetivo = objetivoEl.value;
	  const tipoD = tipoDEl.value;

    let tmb = sexo === "hombre"
        ? 10*peso + 6.25*altura - 5*edad + 5
        : 10*peso + 6.25*altura - 5*edad - 161;

    let calorias = tmb * actividad;

    if (objetivo === "definicion") calorias -= 400;
    if (objetivo === "volumen") calorias += 350;

    calorias = Math.round(calorias);

    const proteinas = Math.round(peso * (objetivo === "definicion" ? 2.2 : 1.8));
    const grasas = Math.round(peso * 0.9);
    const caloriasRestantes =
        calorias - (proteinas*4 + grasas*9);
    const carbos = Math.round(caloriasRestantes / 4);

    const objetivos = {
        desayuno:{
          kcal: Math.round(calorias * 0.3),
          prote: Math.round(proteinas * 0.3),
          carbs: Math.round(carbos * 0.3),
          grasa: Math.round(grasas * 0.3)
        },
        comida: {
          kcal: Math.round(calorias * 0.4),
          prote: Math.round(proteinas * 0.4),
          carbs: Math.round(carbos * 0.4),
          grasa: Math.round(grasas * 0.4)
        },
        merienda: {
          kcal: Math.round(calorias * 0.1),
          prote: Math.round(proteinas * 0.1),
          carbs: Math.round(carbos * 0.1),
          grasa: Math.round(grasas * 0.1)
        },
        cena: {
          kcal: Math.round(calorias * 0.2),
          prote: Math.round(proteinas * 0.2),
          carbs: Math.round(carbos * 0.2),
          grasa: Math.round(grasas * 0.2)
        }
    };

    
    let resultD = {};
    Object.entries(alimentos[tipoD]).forEach(([key, value]) => {
      resultD[key] = optimizadorFlexible(value, objetivos[key], obtenerPrioridades(objetivo));
    });

    // ğŸ½ alimentos (aprox)
    const diet = `
    ğŸ¥£ Desayuno:
    ${pintar(alimentos[tipoD].desayuno, resultD.desayuno)}

    ğŸ— Comida:
    ${pintar(alimentos[tipoD].comida, resultD.comida)}

    ğŸ Merienda:
    ${pintar(alimentos[tipoD].merienda, resultD.merienda)}

    ğŸŸ Cena:
    ${pintar(alimentos[tipoD].cena, resultD.cena)}
    `;

     
    const result = `
    <h3>MacroNutrientes</h3><pre>
    ğŸ”¥ CalorÃ­as: ${calorias} kcal
    ğŸ¥© ProteÃ­nas: ${proteinas} g
    ğŸ¥‘ Grasas: ${grasas} g
    ğŸš Carbohidratos: ${carbos} g
    <hr>
    ${diet}</pre>
    `;

    resultado.innerHTML = result;
    	// ğŸ” Guardar datos
    localStorage.setItem("dietaDatos", JSON.stringify({
        sexo, edad, peso, altura, actividad, objetivo, tipoD, result
    }));

    saveHistory({date:new Date().toLocaleDateString(),calorias,proteinas,carbos,grasas});
    drawChart();
	

}

function optimizadorFlexible(alimentos, objetivos, prioridad) {

  const iteraciones = 3000;
  const learningRate = 0.01;

  let gramos = new Array(alimentos.length).fill(100);

  function calcularTotales(gs) {
    let kcal = 0, prote = 0, carbs = 0, grasa = 0;

    gs.forEach((g, i) => {
      kcal  += g * alimentos[i].kcal / 100;
      prote += g * alimentos[i].proteina / 100;
      carbs += g * alimentos[i].carbs / 100;
      grasa += g * alimentos[i].grasa / 100;
    });

    return { kcal, prote, carbs, grasa };
  }

  function varianza(array) {
    const media = array.reduce((a,b)=>a+b,0) / array.length;
    return array.reduce((acc, val) =>
      acc + Math.pow(val - media, 2), 0) / array.length;
  }

  function coste(gs) {

    const t = calcularTotales(gs);

    return (
      Math.abs(t.kcal - objetivos.kcal) * prioridad.calorias +
      Math.abs(t.prote - objetivos.prote) * prioridad.proteina +
      Math.abs(t.carbs - objetivos.carbs) * prioridad.carbs +
      Math.abs(t.grasa - objetivos.grasa) * prioridad.grasa +
      varianza(gs) * prioridad.equilibrio
    );
  }

  for (let iter = 0; iter < iteraciones; iter++) {

    const baseCoste = coste(gramos);

    for (let i = 0; i < gramos.length; i++) {

      const copia = [...gramos];
      copia[i] += 1;

      const gradiente = coste(copia) - baseCoste;

      gramos[i] -= learningRate * gradiente;

      if (gramos[i] < 0) gramos[i] = 0;
    }
  }

  return {
    gramos: gramos.map(g => Math.round(g)),
    totales: calcularTotales(gramos)
  };
}

function obtenerPrioridades(modo) {

  switch (modo) {

    case "definicion":
      return {
        calorias: 3,
        proteina: 5,
        carbs: 1,
        grasa: 4,
        equilibrio: 0.002
      };

    case "volumen":
      return {
        calorias: 3,
        proteina: 3,
        carbs: 3,
        grasa: 1,
        equilibrio: 0.2
      };

    case "mantenimiento":
      return {
        calorias: 2,
        proteina: 2,
        carbs: 2,
        grasa: 2,
        equilibrio: 0.02
      };
  }
}
function pintar(alimentos, result) {
    var paint = "";
    result.gramos.forEach((g, i) => {
      paint += `\t-${alimentos[i].nombre}: ${g} g\n`; 
    });
    paint += `\n\tTotales: \n\t kcal: ${Math.round(result.totales.kcal)} \n\t Prote: ${Math.round(result.totales.prote)} \n\t Carbs: ${Math.round(result.totales.carbs)} \n\t Grasa: ${Math.round(result.totales.grasa)}`;
    return paint;
}

function drawChart(){
  const history = loadHistory();
  const labels = history.map(h=>h.date);
  if(chart) chart.destroy();

  chart = new Chart(ctx,{
  type:"line",
  data:{
  labels,
  datasets:[
  {label:"CalorÃ­as",data:history.map(h=>h.calorias),borderWidth:2},
  {label:"ProteÃ­na",data:history.map(h=>h.proteinas),borderWidth:2},
  {label:"Carbos",data:history.map(h=>h.carbos),borderWidth:2},
  {label:"Grasas",data:history.map(h=>h.grasas),borderWidth:2}
  ]
  },
  options:{responsive:true}
  });
}

function getRandomInt(max) {
  return Math.floor(Math.random() * max);
}

drawChart();
</script>
</body>
</html>
